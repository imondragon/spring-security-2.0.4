<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;2.&nbsp;Security Namespace Configuration</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"><link rel="start" href="springsecurity.html" title="Spring Security"><link rel="up" href="getting-started.html" title="Part&nbsp;I.&nbsp;Getting Started"><link rel="prev" href="introduction.html" title="Chapter&nbsp;1.&nbsp;Introduction"><link rel="next" href="sample-apps.html" title="Chapter&nbsp;3.&nbsp;Sample Applications"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns:fo="http://www.w3.org/1999/XSL/Format" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://static.springframework.org/spring-security/site/" title="The Spring Framework - Spring Web Services"><img style="border:none;" src="images/xdev-spring_logo.jpg"></a><a style="border:none;" href="http://www.springsource.com/" title="SpringSource"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/s2-banner-rhs.png"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="ns-config"></a>Security Namespace Configuration</h1></div></div></div>
  
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d4e121"></a>2.1.&nbsp;Introduction</h2></div></div></div>
    
    <p>
      Namespace configuration has been available since version 2.0 of the Spring framework. It
      allows you to supplement the traditional Spring beans application context syntax with elements
      from additional XML schema. You can find more information in the Spring
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://static.springframework.org/spring/docs/2.5.x/reference/xsd-config.html" target="_top">
        Reference Documentation</a>. A namespace element can be used simply to allow a more
      concise way of configuring an individual bean or, more powerfully, to define an alternative
      configuration syntax which more closely matches the problem domain and hides the underlying
      complexity from the user. A simple element may conceal the fact that multiple beans and
      processing steps are being added to the application context. For example, adding the following
      element from the security namespace to an application context will start up an embedded LDAP
      server for testing use within the application:
      </p><pre class="programlisting"> 
  &lt;security:ldap-server /&gt;
</pre><p>
      This is much simpler than wiring up the equivalent Apache Directory Server beans. The most
      common alternative configuration requirements are supported by attributes on the
      <code class="literal">ldap-server</code>
      element and the user is isolated from worrying about which beans they need to be set on and
      what the bean property names are.
      <sup>[<a name="d4e127" href="#ftn.d4e127">1</a>]</sup>. Use of a good XML editor while editing the application context file should
      provide information on the attributes and elements that are available. We would recommend that
      you try out the
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.springsource.com/products/sts" target="_top">SpringSource Tool Suite</a>
      as it has special features for working with the Spring portfolio namespaces.
    </p>
    <p>
      To start using the security namespace in your application context, all you need to do is add
      the schema declaration to your application context file:
      </p><pre class="programlisting">
  
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:security="http://www.springframework.org/schema/security"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
              http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd"&gt;  
    ...
&lt;/beans&gt;
  </pre><p>
      In many of the examples you will see (and in the sample) applications, we will often use
      "security" as the default namespace rather than "beans", which means we can omit the prefix on
      all the security namespace elements, making the context easier to read. You may also want to
      do this if you have your application context divided up into separate files and have most of
      your security configuration in one of them. Your security application context file would then
      start like this
      </p><pre class="programlisting">
&lt;beans:beans xmlns="http://www.springframework.org/schema/security"
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
              http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd"&gt; 
    ...
&lt;/beans:beans&gt;
</pre><p>
      We'll assume this syntax is being used from now on in this chapter.
    </p>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d4e135"></a>2.1.1.&nbsp;Design of the Namespace</h3></div></div></div>
      
      <p>
        The namespace is designed to capture the most common uses of the framework and provide a
        simplified and concise syntax for enabling them within an application. The design is largely
        based around the large-scale dependencies within the framework, and can be divided up into
        the following areas:
        </p><div class="itemizedlist"><ul type="disc"><li>
            <p>
              <span class="emphasis"><em>Web/HTTP Security</em></span>
              - the most complex part. Sets up the filters and related service beans used to apply
              the framework authentication mechanisms, to secure URLs, render login and error pages
              and much more.</p>
          </li><li>
            <p>
              <span class="emphasis"><em>Business Object (Method) Security</em></span>
              - options for securing the service layer.</p>
          </li><li>
            <p>
              <span class="emphasis"><em>AuthenticationManager</em></span>
              - handles authentication requests from other parts of the framework. A default 
            instance will be registered internally by the namespace.</p>
          </li><li>
            <p>
              <span class="emphasis"><em>AccessDecisionManager</em></span>
              - provides access decisions for web and method security. A default one will be
              registered, but you can also choose to use a custom one, declared using normal Spring
              bean syntax.</p>
          </li><li>
            <p>
              <span class="emphasis"><em>AuthenticationProvider</em></span>s - mechanisms against which the
              authentication manager authenticates users. The namespace provides supports for
              several standard options and also a means of adding custom beans declared using a
              traditional syntax.
            </p>
          </li><li>
            <p>
              <span class="emphasis"><em>UserDetailsService</em></span>
              - closely related to authentication providers, but often also required by other beans.</p>
          </li></ul></div><p>
      </p>
      <p>We'll see how these work together in the following sections.</p>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-getting-started"></a>2.2.&nbsp;Getting Started with Security Namespace Configuration</h2></div></div></div>
    
    <p>
      In this section, we'll look at how you can build up a namespace configuration to use some of the main
      features of the framework. Let's assume you initially want to get up and running as quickly as possible 
      and add authentication support and access control to an existing web application, with a few 
      test logins. Then we'll look at how to change over to authenticating against a database or other
      security information repository. In later sections we'll introduce more advanced namespace configuration
      options.
    </p>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-web-xml"></a>2.2.1.&nbsp;<code class="literal">web.xml</code> Configuration</h3></div></div></div>
      
      <p>
       The first thing you need to do is add the following filter declaration to your
      <code class="literal">web.xml</code>
      file:
      </p><pre class="programlisting">
          
&lt;filter&gt;
  &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
  &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
  
&lt;filter-mapping&gt;
  &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;   
      </pre><p>
        This provides a hook into the Spring Security web infrastructure. <code class="classname">DelegatingFilterProxy</code>
        is a Spring Framework class which delegates to a filter implementation which is defined as a Spring bean in your
        application context. In this case, the bean is named "springSecurityFilterChain", which is an internal infrastructure 
        bean created by the namespace to handle web security. Note that you should not use this bean name yourself. 
        Once you've added this to your <code class="filename">web.xml</code>, you're ready to start editing your application
        context file. Web security services are configured using the <code class="literal">&lt;http&gt;</code>
        element. 
      </p>
    </div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-minimal"></a>2.2.2.&nbsp;A Minimal <code class="literal">&lt;http&gt;</code> Configuration</h3></div></div></div>
      
      <p>
 All you need to enable web security to begin with is
        </p><pre class="programlisting">
  &lt;http auto-config='true'&gt;
    &lt;intercept-url pattern="/**" access="ROLE_USER" /&gt;
  &lt;/http&gt;
  
</pre><p>
        Which says that we want all URLs within our application to be secured, requiring the role
        <code class="literal">ROLE_USER</code> to access them.</p>
      <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>You can use multiple <code class="literal">&lt;intercept-url&gt;</code> elements to define
        different access requirements for different sets of URLs, but they will be evaluated in the 
        order listed and the first match will be used. So you must put the most specific matches at the top.</p></div>
      <p>
        To add some users, you can define a set of test data directly in the
        namespace:
        </p><pre class="programlisting">
  &lt;authentication-provider&gt;
    &lt;user-service&gt;
      &lt;user name="jimi" password="jimispassword" authorities="ROLE_USER, ROLE_ADMIN" /&gt;
      &lt;user name="bob" password="bobspassword" authorities="ROLE_USER" /&gt;
    &lt;/user-service&gt;
  &lt;/authentication-provider&gt;
  
        </pre><p>
      </p>
      <div class="sidebar"><p class="title"><b></b></p>
        <p>If you are familiar with previous versions of the framework, you can probably
          already guess roughly what's going on here. The &lt;http&gt; element is 
          responsible for creating a <code class="classname">FilterChainProxy</code> and the
          filter beans which it uses. Common issues like incorrect filter ordering are no 
          longer an issue as the filter positions are predefined.</p>
        <p>The <code class="literal">&lt;authentication-provider&gt;</code>
          element creates a <code class="classname">DaoAuthenticationProvider</code>
          bean and the <code class="literal">&lt;user-service&gt;</code> element creates an 
          <code class="classname">InMemoryDaoImpl</code>. A <code class="literal">ProviderManager</code>
          bean is always created by the namespace processing system and the
          <code class="classname">DaoAuthenticationProvider</code>
          is automatically registered with it. You can find more detailed 
          information on the beans that are created in the <a href="appendix-namespace.html" title="Appendix&nbsp;B.&nbsp;The Security Namespace">namespace appendix</a>. 
        </p>
      </div>
      <p>
        The configuration above defines two users, their passwords and their roles within the application (which will
        be used for access control). It is also possible to load user information from
        a standard properties file using the <code class="literal">properties</code> attribute on 
        <code class="literal">user-service</code>. See the section on 
        <a href="authentication-common-auth-services.html#in-memory-service" title="8.2.1.&nbsp;In-Memory Authentication">in-memory authentication</a> for more details. 
        Using the <code class="literal">&lt;authentication-provider&gt;</code>
        element means that the user information will be used by the authentication
        manager to process authentication requests.        
      </p>
      <p>
        At this point you should be able to start up your application and you will be required to
        log in to proceed. Try it out, or try experimenting with the "tutorial" sample application
        that comes with the project. The above configuration actually adds quite a few services to
        the application because we have used the
        <code class="literal">auto-config</code>
        attribute. For example, form login processing and "remember-me" services are automatically
        enabled.
      </p>
      <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="ns-auto-config"></a>2.2.2.1.&nbsp;What does <code class="literal">auto-config</code> Include?</h4></div></div></div>
        
        <p>
          The <code class="literal">auto-config</code> attribute, as we have used it above, is just a 
          shorthand syntax for:
          </p><pre class="programlisting">
  &lt;http&gt;
    &lt;intercept-url pattern="/**" access="ROLE_USER" /&gt;
    &lt;form-login /&gt;
    &lt;anonymous /&gt;
    &lt;http-basic /&gt;
    &lt;logout /&gt;
    &lt;remember-me /&gt;
  &lt;/http&gt;
  
          </pre><p>
          These other elements are responsible for setting up form-login, 
          <a href="anonymous.html" title="Chapter&nbsp;17.&nbsp;Anonymous Authentication">anonymous authentication</a>, basic authentication, logout handling and remember-me services
          respectively. They each have attributes which can be used to alter their behaviour.
        </p>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><code class="literal">auto-config</code> Requires a UserDetailsService</h3>
          
          <p>An error can occur when using auto-config without a <code class="interfacename">UserDetailsService</code> in
          your application context (for example, if you are using LDAP authentication). 
          This is because remember-me is automatically enabled when <code class="literal">auto-config="true"</code> and it requires
            an authentication mechanism which uses a <code class="interfacename">UserDetailsService</code> to function (see 
            the <a href="remember-me.html" title="Chapter&nbsp;14.&nbsp;Remember-Me Authentication">Remember-me chapter</a> for more details). If you have an error caused
            by a missing <code class="interfacename">UserDetailsService</code> then try removing the <code class="literal">auto-config</code> 
            setting (and any <code class="literal">remember-me</code> setting you might have).  
          </p>
        </div>
      </div>
      <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="ns-form-and-basic"></a>2.2.2.2.&nbsp;Form and Basic Login Options</h4></div></div></div>
        
      <p>
        You might be wondering where the login form came from when you were prompted
        to log in, since we made no mention of any HTML files or JSPs. In fact, since we didn't explicitly 
        set a URL for the login page, Spring Security generates one automatically, based on the features
        that are enabled and using standard values for the URL which processes the submitted login,
        the default target URL the user will be sent to and so on. However, the namespace offers plenty of 
        suppport to allow you to customize these options.
        For example, if you want to supply your own login page, you could use:
        </p><pre class="programlisting">
  &lt;http auto-config='true'&gt;
    &lt;intercept-url pattern="/login.jsp*" filters="none"/&gt;  
    &lt;intercept-url pattern="/**" access="ROLE_USER" /&gt;
    &lt;form-login login-page='/login.jsp'/&gt;
  &lt;/http&gt;
  
        </pre><p>
        Note that you can still use <code class="literal">auto-config</code>. The <code class="literal">form-login</code> element just overrides the 
        default settings. Also note that we've added an extra <code class="literal">intercept-url</code> element to say that any requests
        for the login page should be excluded from processing by the security filters. Otherwise the request would be matched by
        the pattern <code class="literal">/**</code> and it wouldn't be possible to access the login page itself!
        If you want to use basic authentication instead of form login, then change the configuration to
        </p><pre class="programlisting">
  &lt;http auto-config='true'&gt;
    &lt;intercept-url pattern="/**" access="ROLE_USER" /&gt;
    &lt;http-basic /&gt;
  &lt;/http&gt;
  
        </pre><p>
        Basic authentication will then take precedence and will be used to prompt for a login when a user attempts to access
        a protected resource. Form login is still available in this configuration if you wish to use it, for example
        through a login form embedded in another web page.
      </p>
        <div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="ns-form-target"></a>2.2.2.2.1.&nbsp;Setting a Default Post-Login Destination</h5></div></div></div>
          
          <p>
            If a form login isn't prompted by an attempt to access a protected resource, the <code class="literal">default-target-url</code>
            option comes into play. This is the URL the user will be taken to after logging in, and defaults to "/". You can
            also configure things so that they user <span class="emphasis"><em>always</em></span> ends up at this page (regardless of whether 
            the login was "on-demand" or they explicitly chose to log in) by setting the 
            <code class="literal">always-use-default-target</code> attribute to "true". This is useful if your application always
            requires that the user starts at a "home" page, for example:
            </p><pre class="programlisting">
  &lt;http&gt;
    &lt;intercept-url pattern='/login.htm*' filters='none'/&gt;  
    &lt;intercept-url pattern='/**' access='ROLE_USER' /&gt;
    &lt;form-login login-page='/login.htm' default-target-url='/home.htm' always-use-default-target='true' /&gt;
  &lt;/http&gt;
  
            </pre><p>
          </p>
        
        </div>
      </div>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-auth-providers"></a>2.2.3.&nbsp;Using other Authentication Providers</h3></div></div></div>
      
      <p>
        In practice you will need a more scalable source of user information than a few names added to the application context file.
        Most likely you will want to store your user information in something like a database or an LDAP server. LDAP namespace
        configuration is dealt with in the <a href="ldap.html" title="Chapter&nbsp;10.&nbsp;LDAP Authentication">LDAP chapter</a>, so we won't cover it here. If you have a
        custom implementation of Spring Security's <code class="classname">UserDetailsService</code>, called "myUserDetailsService" in your
        application context, then you can authenticate against this using
        </p><pre class="programlisting">
  &lt;authentication-provider user-service-ref='myUserDetailsService'/&gt;
  
        </pre><p>
        If you want to use a database, then you can use 
        </p><pre class="programlisting">
  &lt;authentication-provider&gt;
    &lt;jdbc-user-service data-source-ref="securityDataSource"/&gt;
  &lt;/authentication-provider&gt;
  
        </pre><p>
        Where "securityDataSource" is the name of a <code class="classname">DataSource</code> bean in the application context,
        pointing at a database containing the standard Spring Security user data tables. Alternatively, you could configure
        a Spring Security <code class="classname">JdbcDaoImpl</code> bean and point at that using the <code class="literal">user-service-ref</code>
        attribute:
        </p><pre class="programlisting">
  &lt;authentication-provider user-service-ref='myUserDetailsService'/&gt;
  
  &lt;beans:bean id="myUserDetailsService" class="org.springframework.security.userdetails.jdbc.JdbcDaoImpl"&gt;
    &lt;beans:property name="dataSource" ref="dataSource"/&gt;
  &lt;/beans:bean&gt;
  
        </pre><p>
        You can also use standard <code class="interfacename">AuthenticationProvider</code> beans by adding the 
        <code class="literal">&lt;custom-authentication-provider&gt;</code> element within the bean definition. See 
        <a href="ns-config.html#ns-auth-manager" title="2.6.&nbsp;The Default Authentication Manager">Section&nbsp;2.6, &#8220;The Default Authentication Manager&#8221;</a> for more on this.
      </p>
      <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d4e247"></a>2.2.3.1.&nbsp;Adding a Password Encoder</h4></div></div></div>
        <p>
          Often your password data will be encoded using a hashing algorithm. This is supported by the <code class="literal">&lt;password-encoder&gt;</code>
          element. With SHA encoded passwords, the original authentication provider configuration would look like this: 
          </p><pre class="programlisting">
&lt;authentication-provider&gt;
  &lt;password-encoder hash="sha"/&gt;
  &lt;user-service&gt;
    &lt;user name="jimi" password="d7e6351eaa13189a5a3641bab846c8e8c69ba39f" authorities="ROLE_USER, ROLE_ADMIN" /&gt;
    &lt;user name="bob" password="4e7421b1b8765d8f9406d87e7cc6aa784c4ab97f" authorities="ROLE_USER" /&gt;
  &lt;/user-service&gt;
&lt;/authentication-provider&gt;
  
          </pre><p> 
        </p>
        <p>
          When using hashed passwords, it's also a good idea to use a salt value to protect against dictionary attacks and Spring Security supports this too.
          Ideally you would want to use a randomly generated salt value for each user, but you can use any property of the <code class="classname">UserDetails</code>
          object which is loaded by your <code class="classname">UserDetailsService</code>. For example, to use the <code class="literal">username</code> property, you would use
          </p><pre class="programlisting">
&lt;password-encoder hash="sha"&gt;
  &lt;salt-source user-property="username"/&gt;
&lt;/password-encoder&gt;
    </pre><p>
          You can use a custom password encoder bean by using the <code class="literal">ref</code> attribute of <code class="literal">password-encoder</code>. This should
          contain the name of a bean in the application context which is an instance of Spring Security's <code class="interfacename">PasswordEncoder</code>
          interface.
        </p>
      </div>
    </div>
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-web-advanced"></a>2.3.&nbsp;Advanced Web Features</h2></div></div></div>
    
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-remember-me"></a>2.3.1.&nbsp;Remember-Me Authentication</h3></div></div></div>
      
      <p>See the separate <a href="remember-me.html" title="Chapter&nbsp;14.&nbsp;Remember-Me Authentication">Remember-Me chapter</a> for information on remember-me namespace configuration.</p>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-requires-channel"></a>2.3.2.&nbsp;Adding HTTP/HTTPS Channel Security</h3></div></div></div>
      
      <p>If your application supports both HTTP and HTTPS, and you require that particular URLs can only be accessed over HTTPS, then this is
        directly supported using the <code class="literal">requires-channel</code> attribute on <code class="literal">&lt;intercept-url&gt;</code>:
        </p><pre class="programlisting">
  &lt;http&gt;
    &lt;intercept-url pattern="/secure/**" access="ROLE_USER" requires-channel="https"/&gt;
    &lt;intercept-url pattern="/**" access="ROLE_USER" requires-channel="any"/&gt;  
    ...
  &lt;/http&gt;
        </pre><p>
        With this configuration in place, if a user attempts to access anything matching the "/secure/**"
        pattern using HTTP, they will first be redirected to an HTTPS URL.        
        The available options are "http", "https" or "any". Using the value "any" means that either HTTP or HTTPS
        can be used.
      </p>
      <p>
        If your application uses non-standard ports for HTTP and/or HTTPS, you can specify a list of port mappings as follows:
        </p><pre class="programlisting">        
               
  &lt;http&gt;
    ...
    &lt;port-mappings&gt;
      &lt;port-mapping http="9080" https="9443"/&gt;
    &lt;/port-mappings&gt;
  &lt;/http&gt;
        </pre><p>
        You can find a more in-depth discussion of channel security in <a href="channel-security.html" title="Chapter&nbsp;7.&nbsp;Channel Security">Chapter&nbsp;7, <i xmlns:xlink="http://www.w3.org/1999/xlink">Channel Security</i></a>.
      </p>
    </div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-concurrent-session"></a>2.3.3.&nbsp;Concurrent Session Control</h3></div></div></div>
      
      <p>
        If you wish to place constraints on a single user's ability to log in to your application, 
        Spring Security supports this out of the box with the following simple additions. First you need to add the 
        following listener to your <code class="filename">web.xml</code> file to keep Spring Security updated about
        session lifecycle events:
        </p><pre class="programlisting">        
                   
&lt;listener&gt;
  &lt;listener-class&gt;org.springframework.security.ui.session.HttpSessionEventPublisher&lt;/listener-class&gt;
&lt;/listener&gt;
</pre><p>
        Then add the following line to your application context:
        </p><pre class="programlisting">     
  &lt;http&gt;
    ...
    &lt;concurrent-session-control max-sessions="1" /&gt;
  &lt;/http&gt;
        </pre><p>
        This will prevent a user from logging in multiple times - a second login will cause the first to 
        be invalidated. Often you would prefer to prevent a second login, in which case you can use
        </p><pre class="programlisting">     
  &lt;http&gt;
    ...
    &lt;concurrent-session-control max-sessions="1" exception-if-maximum-exceeded="true"/&gt;
  &lt;/http&gt;
        </pre><p>
        The second login will then be rejected. 
      </p>
    </div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-openid"></a>2.3.4.&nbsp;OpenID Login</h3></div></div></div>
      
      <p>The namespace supports <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://openid.net/" target="_top">OpenID</a> login either instead of, or in addition to
      normal form-based login, with a simple change:
        </p><pre class="programlisting">
  &lt;http&gt;
    &lt;intercept-url pattern="/**" access="ROLE_USER" /&gt;
    &lt;openid-login /&gt;
  &lt;/http&gt;
  </pre><p>
        You should then register yourself with an OpenID provider (such as myopenid.com), and
        add the user information to your in-memory <code class="literal">&lt;user-service&gt;</code>: 
        </p><pre class="programlisting">
  &lt;user name="http://jimi.hendrix.myopenid.com/" password="notused" authorities="ROLE_USER" /&gt;
  </pre><p>
        You should be able to login using the <code class="literal">myopenid.com</code> site to authenticate.
      </p>
    </div>
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-custom-filters"></a>2.3.5.&nbsp;Adding in Your Own Filters</h3></div></div></div>
      
      <p>If you've used Spring Security before, you'll know that the framework maintains a chain
      of filters in order to apply its services. You may want to add your own filters to the stack at
      particular locations or use a Spring Security filter for which there isn't currently a namespace
      configuration option (CAS, for example). Or you might want to use a customized version of a 
      standard namespace filter, such as the <code class="literal">AuthenticationProcessingFilter</code> which is created by the
      <code class="literal">&lt;form-login&gt;</code> element, taking advantage of some of the extra configuration options which are
      available by using defining the bean directly. How can you do this with namespace configuration, 
      since the filter chain is not directly exposed?
      </p>
      <p>The order of the filters is always strictly enforced when using the namespace. Each Spring Security
      filter implements the Spring <code class="interfacename">Ordered</code> interface and the filters created by the namespace
      are sorted during initialization. The standard Spring Security filters each have an alias in the namespace. The filters, aliases
      and namespace elements/attributes which create the filters are shown in <a href="ns-config.html#filter-stack" title="Table&nbsp;2.1.&nbsp;Standard Filter Aliases and Ordering">Table&nbsp;2.1, &#8220;Standard Filter Aliases and Ordering&#8221;</a>.
      </p><div class="table"><a name="filter-stack"></a><p class="title"><b>Table&nbsp;2.1.&nbsp;Standard Filter Aliases and Ordering</b></p><div class="table-contents">
        
        <table summary="Standard Filter Aliases and Ordering" border="1"><colgroup><col><col><col></colgroup><thead><tr><th align="center">Alias</th><th align="center">Filter Class</th><th align="center">Namespace Element or Attribute</th></tr></thead><tbody><tr><td align="left"> CHANNEL_FILTER</td><td align="left"><code class="literal">ChannelProcessingFilter</code></td><td align="left"><code class="literal">http/intercept-url</code></td></tr><tr><td align="left"> CONCURRENT_SESSION_FILTER</td><td align="left"><code class="literal">ConcurrentSessionFilter</code>
              </td><td align="left"><code class="literal">http/concurrent-session-control</code></td></tr><tr><td align="left"> SESSION_CONTEXT_INTEGRATION_FILTER</td><td align="left"><code class="classname">HttpSessionContextIntegrationFilter</code></td><td align="left"><code class="literal">http</code></td></tr><tr><td align="left"> LOGOUT_FILTER </td><td align="left"><code class="literal">LogoutFilter</code></td><td align="left"><code class="literal">http/logout</code></td></tr><tr><td align="left"> X509_FILTER </td><td align="left"><code class="literal">X509PreAuthenticatedProcessigFilter</code></td><td align="left"><code class="literal">http/x509</code></td></tr><tr><td align="left"> PRE_AUTH_FILTER </td><td align="left"><code class="literal">AstractPreAuthenticatedProcessingFilter</code> Subclasses</td><td align="left">N/A</td></tr><tr><td align="left"> CAS_PROCESSING_FILTER </td><td align="left"><code class="literal">CasProcessingFilter</code></td><td align="left">N/A</td></tr><tr><td align="left"> AUTHENTICATION_PROCESSING_FILTER </td><td align="left"><code class="literal">AuthenticationProcessingFilter</code></td><td align="left"><code class="literal">http/form-login</code></td></tr><tr><td align="left"> BASIC_PROCESSING_FILTER </td><td align="left"><code class="literal">BasicProcessingFilter</code></td><td align="left"><code class="literal">http/http-basic</code></td></tr><tr><td align="left"> SERVLET_API_SUPPORT_FILTER</td><td align="left"><code class="literal">SecurityContextHolderAwareRequestFilter</code></td><td align="left"><code class="literal">http/@servlet-api-provision</code></td></tr><tr><td align="left"> REMEMBER_ME_FILTER </td><td align="left"><code class="classname">RememberMeProcessingFilter</code></td><td align="left"><code class="literal">http/remember-me</code></td></tr><tr><td align="left"> ANONYMOUS_FILTER </td><td align="left"><code class="literal">AnonymousProcessingFilter</code></td><td align="left"><code class="literal">http/anonymous</code></td></tr><tr><td align="left"> EXCEPTION_TRANSLATION_FILTER </td><td align="left"><code class="classname">ExceptionTranslationFilter</code></td><td align="left"><code class="literal">http</code></td></tr><tr><td align="left"> NTLM_FILTER </td><td align="left"><code class="literal">NtlmProcessingFilter</code></td><td align="left">N/A</td></tr><tr><td align="left"> FILTER_SECURITY_INTERCEPTOR </td><td align="left"><code class="classname">FilterSecurityInterceptor</code></td><td align="left"><code class="literal">http</code></td></tr><tr><td align="left"> SWITCH_USER_FILTER </td><td align="left"><code class="literal">SwitchUserProcessingFilter</code></td><td align="left">N/A</td></tr></tbody></table>
      </div></div><p><br class="table-break">
        You can add your own filter to the stack, using the <code class="literal">custom-filter</code> element and one of these
        names to specify the position your filter should appear at:
        </p><pre class="programlisting">
  &lt;beans:bean id="myFilter" class="com.mycompany.MySpecialAuthenticationFilter"&gt;
    &lt;custom-filter position="AUTHENTICATION_PROCESSING_FILTER"/&gt;
  &lt;/beans:bean&gt;
  </pre><p>
        You can also use the <code class="literal">after</code> or <code class="literal">before</code> attribtues if you want your filter
        to be inserted before or after another filter in the stack. The names "FIRST" and "LAST" can be used with the 
        <code class="literal">position</code> attribute to indicate that you want your filter to appear before or after the entire stack, respectively.
      </p>
      <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Avoiding filter position conflicts</h3>
        
        <p>
          If you are inserting a custom filter which may occupy the same position as one of the standard filters created by the namespace
          then it's important that you don't include the namespace versions by mistake. Avoid using the 
          <code class="literal">auto-config</code> attribute and remove any elements which create filters whose functionality you want to replace.
        </p>
        <p>
          Note that you can't replace filters which are created by the use of the <code class="literal">&lt;http&gt;</code> 
          element itself - <code class="classname">HttpSessionContextIntegrationFilter</code>, <code class="classname">ExceptionTranslationFilter</code> or
          <code class="classname">FilterSecurityInterceptor</code>.
        </p>
      </div>
      <p>
        If you're replacing a namespace filter which requires an authentication entry point (i.e. where the authentication process is triggered by
        an attempt by an unauthenticated user to access to a secured resource), you will need to add a custom entry point bean too.
      </p>
      <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="ns-entry-point-ref"></a>2.3.5.1.&nbsp;Setting a Custom <code class="interfacename">AuthenticationEntryPoint</code></h4></div></div></div>
        
        <p>
          If you aren't using form login, OpenID or basic authentication through the namespace, you may
          want to define an authentication filter and entry point using a traditional bean syntax and link them
          into the namespace, as we've just seen. The corresponding <code class="interfacename">AuthenticationEntryPoint</code> can be set using the 
          <code class="literal">entry-point-ref</code> attribute on the <code class="literal">&lt;http&gt;</code> element.
        </p>
        <p>
          The CAS sample application is a good example of the use of custom beans with the namespace, including this syntax. If you aren't
          familiar with authentication entry points, they are discussed in the <a href="technical-overview.html#tech-auth-entry-point" title="5.3.2.&nbsp;AuthenticationEntryPoint">technical
            overview</a> chapter.
        </p>
      </div>
    </div>

    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-session-fixation"></a>2.3.6.&nbsp;Session Fixation Attack Protection</h3></div></div></div>
      
      <p>
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Session_fixation" target="_top">Session fixation</a> 
        attacks are a potential risk where it is possible for a malicious attacker to create
        a session by accessing a site, then persuade another user to log in with the same session 
        (by sending them a link containing the session identifier as a parameter, for example). Spring Security
        protects against this automatically by creating a new session when a user logs in. If you don't require
        this protection, or it conflicts with some other requirement, you can control the behaviour using the
        <code class="literal">session-fixation-protection</code> attribute on <code class="literal">&lt;http&gt;</code>, which 
        has three options
        </p><div class="itemizedlist"><ul type="disc"><li><p><code class="literal">migrateSession</code> - creates a new session and copies the existing 
          session attributes to the new session. This is the default.</p></li><li><p><code class="literal">none</code> - Don't do anything. The original session will be retained.</p></li><li><p><code class="literal">newSession</code> - Create a new "clean" session, without copying the existing session data.</p></li></ul></div><p>
      </p>
    </div>
    
  </div>
  
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-method-security"></a>2.4.&nbsp;Method Security</h2></div></div></div>
    

    <p>
      Spring Security 2.0 has improved support substantially for adding security to your service layer methods. If you are
      using Java 5 or greater, then support for JSR-250 security annotations is provided, as well as the framework's native
      <code class="literal">@Secured</code> annotation. You can apply security to a single bean, using the <code class="literal">intercept-methods</code>
      element to decorate the bean declaration, or you can secure multiple beans across the entire service layer using the
      AspectJ style pointcuts.
    </p>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-global-method"></a>2.4.1.&nbsp;The <code class="literal">&lt;global-method-security&gt;</code> Element</h3></div></div></div>
      
      <p>
        This element is used to enable annotation-based security in your application (by setting the appropriate
        attributes on the element), and also to group together security pointcut declarations which will be applied across your 
        entire application context. You should only declare one <code class="literal">&lt;global-method-security&gt;</code> element.
        The following declaration would enable support for both Spring Security's <code class="literal">@Secured</code>, and JSR-250 annotations:
</p><pre class="programlisting">
  &lt;global-method-security secured-annotations="enabled" jsr250-annotations="enabled"/&gt;
  
</pre><p>
        Adding an annotation to a method (on an class or interface) would then limit the access to that method
        accordingly. Spring Security's native annotation support defines a set of attributes for the method. These
        will be passed to the <code class="interfacename">AccessDecisionManager</code> for it to make the actual decision.
        This example is taken from the <a href="sample-apps.html#tutorial-sample" title="3.1.&nbsp;Tutorial Sample">tutorial sample</a>, which is a good
        starting point if you want to use method security in your application:
</p><pre class="programlisting">
  public interface BankService {
  
    @Secured("IS_AUTHENTICATED_ANONYMOUSLY")
    public Account readAccount(Long id);
  
    @Secured("IS_AUTHENTICATED_ANONYMOUSLY")
    public Account[] findAccounts();
  
    @Secured("ROLE_TELLER")
    public Account post(Account account, double amount);
  }
</pre><p>
      </p>
      <div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="ns-protect-pointcut"></a>2.4.1.1.&nbsp;Adding Security Pointcuts using <code class="literal">protect-pointcut</code></h4></div></div></div>
        
        <p>
          The use of <code class="literal">protect-pointcut</code> is particularly powerful, as it allows you to
          apply security to many beans with only a simple declaration. Consider the following example:
          </p><pre class="programlisting">
  &lt;global-method-security&gt;
    &lt;protect-pointcut expression="execution(* com.mycompany.*Service.*(..))" access="ROLE_USER"/&gt;
  &lt;/global-method-security&gt;

          </pre><p>
          This will protect all methods on beans declared in the application context whose classes
          are in the <code class="literal">com.mycompany</code> package and whose class names end in "Service".
          Only users with the <code class="literal">ROLE_USER</code> role will be able to invoke these methods.
          As with URL matching, the most specific matches must come first in the list of pointcuts, as the
          first matching expression will be used.
        </p>
      </div>
      
    </div>
    
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-intercept-methods"></a>2.4.2.&nbsp;The <code class="literal">intercept-methods</code> Bean Decorator</h3></div></div></div>
      
      <p>
        This alternative syntax allows you to specify security for a specific bean by adding this element within the bean itself.
</p><pre class="programlisting">
&lt;bean:bean id="target" class="com.mycompany.myapp.MyBean"&gt;
    &lt;intercept-methods&gt;
        &lt;protect method="set*" access="ROLE_ADMIN" /&gt;
        &lt;protect method="get*" access="ROLE_ADMIN,ROLE_USER" /&gt;
        &lt;protect method="doSomething" access="ROLE_USER" /&gt;
    &lt;/intercept-methods&gt;
&lt;/bean:bean&gt;  
</pre><p>
        This allows you to configure security attributes for individual methods on the bean or simple wildcarded patterns.
      </p>
    </div>

  </div>
  
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-access-manager"></a>2.5.&nbsp;The Default AccessDecisionManager</h2></div></div></div>
    
    <p>
      This section assumes you have some knowledge of the underlying architecture for access-control within 
      Spring Security. If you don't you can skip it and come back to it later, as this section is only really relevant for 
      people who need to do some customization in order to use more than simple role based security.
    </p>
    <p>
      When you use a namespace configuration, a default instance of <code class="interfacename">AccessDecisionManager</code>
      is automatically registered for you and will be used for making access decisions for method invocations
      and web URL access, based on the access attributes you specify in your <code class="literal">intercept-url</code> and 
      <code class="literal">protect-pointcut</code> declarations (and in annotations if you are using annotation secured methods).      
    </p>
    <p>
      The default strategy is to use an <code class="classname">AffirmativeBased</code> <code class="interfacename">AccessDecisionManager</code>
      with a <code class="classname">RoleVoter</code> and an <code class="classname">AuthenticatedVoter</code>.
    </p>
      
    <div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="ns-custom-access-mgr"></a>2.5.1.&nbsp;Customizing the AccessDecisionManager</h3></div></div></div>
      
      <p>
        If you need to use a more complicated access control strategy then it is easy to set an alternative for both
        method and web security.
      </p>
      <p>
        For method security, you  do this by setting the <code class="literal">access-decision-manager-ref</code> attribute 
        on <code class="literal">global-method-security</code>to the Id of the appropriate 
        <code class="interfacename">AccessDecisionManager</code> bean in the application context:
        </p><pre class="programlisting">
  &lt;global-method-security access-decision-manager-ref="myAccessDecisionManagerBean"&gt;
    ... 
  &lt;/global-method-security&gt;
  </pre><p>
      </p>
      <p>
        The syntax for web security is the same, but on the <code class="literal">http</code> element:
        </p><pre class="programlisting">
  &lt;http access-decision-manager-ref="myAccessDecisionManagerBean"&gt;
    ... 
  &lt;/http&gt;
  </pre><p>
      </p>
    </div>    
  </div>
  <div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-auth-manager"></a>2.6.&nbsp;The Default Authentication Manager</h2></div></div></div>
    
    <p>
      We've touched on the idea that the namespace configuration automatically registers an authentication manager bean for
      you. This is an instance of Spring Security's <code class="classname">ProviderManager</code> class, which you may already 
      be familiar with if you've used the framework before. You can't use a custom <code class="classname">AuthenticationProvider</code> if you are
      using either HTTP or method security through the namespace, but this should not be a problem as you have full control over 
      the <code class="classname">AuthenticationProvider</code>s that are used.
    </p>
    <p>
      You may want to register additional <code class="classname">AuthenticationProvider</code> beans with the <code class="classname">ProviderManager</code>
      and you can do this using the <code class="literal">&lt;custom-authentication-provider&gt;</code> element within the bean. For example:
      </p><pre class="programlisting">
  &lt;bean id="casAuthenticationProvider" 
      class="org.springframework.security.providers.cas.CasAuthenticationProvider"&gt;
    &lt;security:custom-authentication-provider /&gt;
    ...
  &lt;/bean&gt;
  </pre><p>
    </p>
    <p>
      Another common requirement is that another bean in the context may require a reference to the <code class="interfacename">AuthenticationManager</code>.
      There is a special element which lets you register an alias for the <code class="interfacename">AuthenticationManager</code> and you can then
      use this name elsewhere in your application context.
      </p><pre class="programlisting">        
  &lt;security:authentication-manager alias="authenticationManager"/&gt;

  &lt;bean id="customizedFormLoginFilter" class="org.springframework.security.ui.webapp.AuthenticationProcessingFilter"&gt;
     &lt;security:custom-filter position="AUTHENTICATION_PROCESSING_FILTER "/&gt;
     &lt;property name="authenticationManager" ref="authenticationManager"/&gt;
     ...
  &lt;/bean&gt;
  </pre><p>
    </p>
  </div>
  
<div class="footnotes"><br><hr width="100" align="left"><div class="footnote">
        <p><sup>[<a name="ftn.d4e127" href="#d4e127">1</a>] </sup>You can find out more about the use of the
          <code class="literal">ldap-server</code>
          element in the chapter on
          <a href="ldap.html" title="Chapter&nbsp;10.&nbsp;LDAP Authentication">LDAP</a>.</p>
      </div></div></div><div xmlns:fo="http://www.w3.org/1999/XSL/Format" class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="introduction.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="springsecurity.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="sample-apps.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;1.&nbsp;Introduction&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.springsource.com/" title="SpringSource">Sponsored by SpringSource
                                        </a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;3.&nbsp;Sample Applications</td></tr></table></div></body></html>